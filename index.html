<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师工具箱</title>
    <link rel="stylesheet" href="styles.css">
    <script src="student-manager.js"></script>
    <style>
        .container {
            max-width: 1300px;
            margin: 2.5rem auto;
            padding: 0 1.5rem;
        }
        
        /* 工具卡片容器 */
        .tools-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2.2rem;
            margin: 2.5rem 0;
        }
        
        /* 工具卡片 */
        .tool-card {
            background: white;
            border-radius: 18px;
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transform: translateY(0);
        }
        
        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            border-radius: 18px 18px 0 0;
        }
        
        .tool-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .tool-card h2 {
            color: #182848;
            margin-bottom: 1.3rem;
            font-size: 1.9rem;
            font-weight: 700;
        }
        
        .tool-card p {
            color: #555;
            margin-bottom: 1.8rem;
            line-height: 1.7;
            font-size: 1.15rem;
        }
        
        .tool-card button {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 1.1rem 2.3rem;
            font-size: 1.15rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 5px 18px rgba(75, 108, 183, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .tool-card button:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(75, 108, 183, 0.6);
        }
        
        .tool-card button:active {
            transform: scale(0.95);
        }
        
        /* 工具卡片图标 */
        .tool-icon {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            color: #4b6cb7;
            transition: all 0.3s ease;
            display: block;
        }
        
        .tool-card:hover .tool-icon {
            transform: scale(1.2) rotate(5deg);
        }
        
        /* 学生管理区域 */
        .student-management-container {
            transition: all 0.4s ease;
        }
        
        .student-management-container.hidden {
            display: none;
        }
        
        .student-management {
            background: white;
            border-radius: 18px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin: 2.5rem 0;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: visible;
        }
        
        .student-management::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            border-radius: 18px 18px 0 0;
        }
        
        .student-management.hidden {
            transform: translateY(-20px);
            opacity: 0;
            pointer-events: none;
            max-height: 0;
            padding: 0 !important;
            margin: 0 !important;
            border: none;
            overflow: hidden;
            display: none;
        }
        
        .student-management h2 {
            color: #182848;
            margin-bottom: 1.8rem;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
        }
        
        .student-input-section {
            margin-bottom: 2.2rem;
        }
        
        .input-group {
            display: flex;
            gap: 1.2rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }
        
        .input-group input {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .input-group input:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(75, 108, 183, 0.6);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #cccccc, #999999);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.add {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }
        
        .btn.import {
            background: linear-gradient(135deg, #9C27B0, #E040FB);
        }
        
        .btn.clear {
            background: linear-gradient(135deg, #FF5722, #FF9800);
        }
        
        .btn.toggle-students {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            display: block;
            margin: 1.8rem auto;
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
        }
        
        .btn.feedback {
            background: linear-gradient(135deg, #FF9800, #FFC107);
            display: block;
            margin: 1.2rem auto;
            padding: 1.1rem 2.2rem;
            font-size: 1.15rem;
        }
        
        .batch-import {
            margin: 1.3rem 0;
            padding: 1.3rem;
            background: rgba(227, 242, 253, 0.8);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(179, 219, 255, 0.5);
        }
        
        .batch-import h3 {
            color: #182848;
            margin-bottom: 0.8rem;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .batch-import textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            margin-bottom: 1.2rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .batch-import textarea:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
            outline: none;
        }
        
        .file-import {
            margin: 1.3rem 0;
            padding: 1.3rem;
            background: rgba(227, 242, 253, 0.8);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(179, 219, 255, 0.5);
        }
        
        .file-import h3 {
            color: #182848;
            margin-bottom: 0.8rem;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .file-import input {
            width: 100%;
            margin-bottom: 1.2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .file-import input:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
            outline: none;
        }
        
        .student-list-container {
            max-height: 320px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 1.2rem;
            background: rgba(248, 249, 250, 0.9);
            margin-top: 1.5rem;
            backdrop-filter: blur(5px);
            /* 确保滚动条始终可用 */
            -webkit-overflow-scrolling: touch;
            /* 确保在所有设备上都能正常滚动 */
            scrollbar-width: thin;
            scrollbar-color: #4b6cb7 rgba(248, 249, 250, 0.9);
        }
        
        /* 自定义滚动条样式（WebKit浏览器） */
        .student-list-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .student-list-container::-webkit-scrollbar-track {
            background: rgba(248, 249, 250, 0.9);
            border-radius: 4px;
        }
        
        .student-list-container::-webkit-scrollbar-thumb {
            background: #4b6cb7;
            border-radius: 4px;
        }
        
        .student-list-container::-webkit-scrollbar-thumb:hover {
            background: #3a5795;
        }
        
        .student-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
            transition: all 0.2s ease;
        }
        
        .student-item:hover {
            background: rgba(227, 242, 253, 0.6);
            border-radius: 8px;
        }
        
        .student-item:last-child {
            border-bottom: none;
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-id {
            font-weight: bold;
            color: #4b6cb7;
        }
        
        .remove-student {
            background: #ff416c;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .remove-student:hover {
            background: #ff1a4f;
            transform: scale(1.1);
        }
        
        .student-summary {
            display: flex;
            justify-content: center;
            gap: 2.2rem;
            margin-top: 1.8rem;
            flex-wrap: wrap;
        }
        
        .summary-card {
            background: rgba(227, 242, 253, 0.8);
            border-radius: 14px;
            padding: 1.7rem;
            text-align: center;
            min-width: 160px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(179, 219, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .summary-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #182848;
        }
        
        .summary-label {
            font-size: 1.1rem;
            color: #555;
            margin-top: 0.5rem;
        }
        
        .instructions {
            background: rgba(227, 242, 253, 0.8);
            border-radius: 18px;
            padding: 2.2rem;
            margin-top: 2.8rem;
            text-align: left;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(179, 219, 255, 0.5);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h3 {
            color: #182848;
            margin-bottom: 1.8rem;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .instructions ol {
            padding-left: 2.2rem;
        }
        
        .instructions li {
            margin-bottom: 1rem;
            line-height: 1.8;
            font-size: 1.2rem;
            color: #444;
        }
        
        .instructions strong {
            color: #4b6cb7;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header>
        <h1>教师工具箱</h1>
        <p>专为教师设计的实用工具集合</p>
    </header>
    
    <div class="container">
        <!-- 工具卡片 -->
        <div class="tools-container">
            <div class="tool-card" id="sound-detector-card">
                <div class="tool-icon">🔊</div>
                <h2>声音检测器</h2>
                <p>实时检测环境声音强度，声音越高小球越高</p>
                <button onclick="navigateTo('sound-detector.html')">立即使用</button>
            </div>
            
            <div class="tool-card" id="roll-call-card">
                <div class="tool-icon">🎲</div>
                <h2>随机点名器</h2>
                <p>随机选择学生回答问题，增加课堂互动</p>
                <button onclick="navigateTo('roll-call.html')">立即使用</button>
            </div>
            
            <div class="tool-card" id="timer-card">
                <div class="tool-icon">⏱️</div>
                <h2>课堂计时器</h2>
                <p>管理课堂活动时间，提高教学效率</p>
                <button onclick="navigateTo('timer.html')">立即使用</button>
            </div>
            
            <div class="tool-card" id="grouping-card">
                <div class="tool-icon">👥</div>
                <h2>小组分组器</h2>
                <p>随机分组学生，便于小组活动</p>
                <button onclick="navigateTo('grouping.html')">立即使用</button>
            </div>
            
            <div class="tool-card" id="whiteboard-card">
                <div class="tool-icon">✏️</div>
                <h2>电子白板</h2>
                <p>在线绘制和演示，支持多点触控</p>
                <button onclick="navigateTo('whiteboard.html')">立即使用</button>
            </div>
            
            <div class="tool-card" id="tracker-card">
                <div class="tool-icon">📈</div>
                <h2>课堂表现记录器</h2>
                <p>记录学生课堂表现，提升教学效果</p>
                <button onclick="navigateTo('classroom-tracker.html')">立即使用</button>
            </div>
        </div>
        
        <!-- 切换学生管理按钮 -->
        <button id="toggleStudentsBtn" class="btn toggle-students">管理学生信息</button>
        
        <!-- 学生管理区域 -->
        <div class="student-management-container">
            <div class="student-management" id="studentManagement">
                <h2>学生管理</h2>
            
            <div class="student-input-section">
                <div class="input-group">
                    <input type="text" id="studentId" placeholder="学号（可选）">
                    <input type="text" id="studentName" placeholder="学生姓名">
                    <button id="addStudentBtn" class="btn add">添加学生</button>
                </div>
                
                <div class="batch-import">
                    <h3>批量导入（CSV格式：学号,姓名）</h3>
                    <textarea id="csvInput" placeholder="例如：
2021001,张三
2021002,李四
2021003,王五"></textarea>
                    <button id="importBtn" class="btn import">导入CSV</button>
                </div>
                
                <div class="file-import">
                    <h3>文件导入（支持CSV、TXT格式）</h3>
                    <input type="file" id="fileInput" accept=".csv,.txt">
                    <button id="importFileBtn" class="btn import">导入文件</button>
                    <div id="fileInfo" style="margin-top: 0.8rem; font-size: 1rem; color: #666;"></div>
                </div>
                
                <button id="clearStudentsBtn" class="btn clear">清空学生列表</button>
            </div>
            
            <div class="student-list-container">
                <div id="studentList">
                    <div class="empty-list">暂无学生，请添加学生</div>
                </div>
            </div>
            
            <div class="student-summary">
                <div class="summary-card">
                    <div class="summary-value" id="totalStudents">0</div>
                    <div class="summary-label">总学生数</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="totalGroups">0</div>
                    <div class="summary-label">建议分组数</div>
                </div>
            </div>
        </div>
    </div>
        
        <!-- 反馈建议按钮 -->
        <button id="feedbackBtn" class="btn feedback">反馈建议</button>
    </div>
    
    <div class="container">
        <div class="instructions">
            <h3>使用说明</h3>
            <ol>
                <li><strong>学生管理</strong> - 点击"管理学生信息"按钮显示学生管理界面，支持单个添加、批量导入和文件导入</li>
                <li><strong>声音检测器</strong> - 实时检测环境声音强度，声音越高小球越高，可用于课堂活跃度监测</li>
                <li><strong>随机点名器</strong> - 随机选择学生回答问题，增加课堂互动，支持导入学生名单</li>
                <li><strong>课堂计时器</strong> - 管理课堂活动时间，提高教学效率，支持全屏模式和预设时间</li>
                <li><strong>小组分组器</strong> - 随机分组学生，便于小组活动，支持自定义分组人数</li>
                <li><strong>电子白板</strong> - 在线绘制和演示，支持多点触控、多种颜色和线条粗细调节</li>
                <li><strong>课堂表现记录器</strong> - 记录学生课堂表现，帮助教师了解学生参与度</li>
                <li><strong>反馈建议</strong> - 点击"反馈建议"按钮提交您的宝贵意见</li>
            </ol>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 教师工具箱 - 专为教师设计</p>
    </footer>
    
    <script>
        // 获取DOM元素
        const toggleStudentsBtn = document.getElementById('toggleStudentsBtn');
        const studentManagement = document.getElementById('studentManagement');
        const studentManagementContainer = studentManagement.parentElement;
        const studentId = document.getElementById('studentId');
        const studentName = document.getElementById('studentName');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const csvInput = document.getElementById('csvInput');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        const importFileBtn = document.getElementById('importFileBtn');
        const clearStudentsBtn = document.getElementById('clearStudentsBtn');
        const studentList = document.getElementById('studentList');
        const totalStudentsEl = document.getElementById('totalStudents');
        const totalGroupsEl = document.getElementById('totalGroups');
        const fileInfo = document.getElementById('fileInfo');
        const feedbackBtn = document.getElementById('feedbackBtn');
        
        // 切换学生管理界面显示/隐藏
        function toggleStudentManagement(event) {
            const isHidden = studentManagementContainer.classList.contains('hidden');
            
            if (isHidden) {
                // 显示学生管理区域
                studentManagementContainer.classList.remove('hidden');
                toggleStudentsBtn.textContent = '隐藏学生管理';
                
                // 重新渲染学生列表以确保滚动功能正常
                renderStudentList();
            } else {
                // 隐藏学生管理区域
                studentManagementContainer.classList.add('hidden');
                toggleStudentsBtn.textContent = '管理学生信息';
            }
            
            // 阻止事件冒泡
            if (event && event.stopPropagation) {
                event.stopPropagation();
            }
        }
        
        // 简化版自定义弹窗函数，使用系统alert替代
        function showCustomModal(title, message, callback) {
            alert(`${title}\n\n${message}`);
            if (callback && typeof callback === 'function') {
                callback();
            }
        }
        
        // 添加学生
        function addStudent() {
            const id = studentId.value.trim();
            const name = studentName.value.trim();
            
            if (!name) {
                showCustomModal('提示', '请输入学生姓名');
                return;
            }
            
            // 禁用添加按钮，防止重复点击
            addStudentBtn.disabled = true;
            addStudentBtn.textContent = '添加中...';
            
            // 使用StudentManager来处理学生输入
            const student = { id, name };
            if (StudentManager.addStudent(student)) {
                renderStudentList();
                updateSummary();
                studentId.value = '';
                studentName.value = '';
                studentName.focus();
                // 恢复按钮状态
                addStudentBtn.disabled = false;
                addStudentBtn.textContent = '添加学生';
            } else {
                showCustomModal('提示', '学生已存在（学号或姓名重复）');
                // 恢复按钮状态
                addStudentBtn.disabled = false;
                addStudentBtn.textContent = '添加学生';
            }
        }
        
        // 批量导入学生
        function importStudents() {
            const csvText = csvInput.value.trim();
            if (csvText === '') {
                showCustomModal('提示', '请输入CSV数据');
                return;
            }
            
            // 禁用导入按钮，防止重复点击
            importBtn.disabled = true;
            importBtn.textContent = '导入中...';
            
            try {
                const students = StudentManager.parseCSV(csvText);
                if (students.length === 0) {
                    showCustomModal('提示', '未解析到有效学生数据');
                    // 恢复按钮状态
                    importBtn.disabled = false;
                    importBtn.textContent = '导入CSV';
                    return;
                }
                
                const addedCount = StudentManager.addStudents(students);
                renderStudentList();
                updateSummary();
                csvInput.value = '';
                showCustomModal('成功', `成功导入 ${addedCount} 名学生`);
            } catch (e) {
                showCustomModal('错误', '导入失败：' + e.message);
            } finally {
                // 恢复按钮状态
                importBtn.disabled = false;
                importBtn.textContent = '导入CSV';
            }
        }
        
        // 文件导入学生
        function importFromFile() {
            const file = fileInput.files[0];
            if (!file) {
                showCustomModal('提示', '请选择一个文件');
                return;
            }
            
            // 检查文件格式，只允许CSV和TXT格式
            if (!file.name.endsWith('.csv') && !file.name.endsWith('.txt')) {
                showCustomModal('错误', '文件格式不支持，请使用CSV或TXT格式的文件');
                fileInput.value = ''; // 清空文件选择
                fileInfo.textContent = '';
                return;
            }
            
            // 显示文件信息
            fileInfo.textContent = `文件名: ${file.name} | 大小: ${(file.size / 1024).toFixed(1)} KB | 类型: ${file.type || '未知'}`;
            
            // 禁用导入按钮，防止重复点击
            importFileBtn.disabled = true;
            importFileBtn.textContent = '导入中...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let students = [];
                    
                    // 根据文件类型处理（只处理CSV和TXT）
                    students = StudentManager.parseCSV(content);
                    
                    if (students.length === 0) {
                        showCustomModal('提示', '未解析到有效学生数据');
                        // 恢复按钮状态
                        importFileBtn.disabled = false;
                        importFileBtn.textContent = '导入文件';
                        return;
                    }
                    
                    const addedCount = StudentManager.addStudents(students);
                    renderStudentList();
                    updateSummary();
                    fileInput.value = '';
                    fileInfo.textContent = '';
                    showCustomModal('成功', `成功导入 ${addedCount} 名学生`);
                } catch (e) {
                    showCustomModal('错误', '导入失败：' + e.message);
                } finally {
                    // 恢复按钮状态
                    importFileBtn.disabled = false;
                    importFileBtn.textContent = '导入文件';
                }
            };
            
            // 读取文件内容
            reader.readAsText(file, 'UTF-8');
        }
        
        // HTML转义函数，防止XSS攻击
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // 删除学生
        function removeStudent(index) {
            showCustomModal('确认删除', '确定要删除这个学生吗？', function() {
                StudentManager.removeStudent(index);
                renderStudentList();
                updateSummary();
            });
        }
        
        // 清空学生列表
        function clearStudents() {
            showCustomModal('确认清空', '确定要清空所有学生吗？', function() {
                StudentManager.clearStudents();
                renderStudentList();
                updateSummary();
            });
        }
        
        // 为课堂表现记录器选择学生
        function selectStudentForTracker(index) {
            const students = StudentManager.getStudents();
            if (index >= 0 && index < students.length) {
                const student = students[index];
                // 保存选中的学生到localStorage
                try {
                    localStorage.setItem('classroom_tracker_current_student', JSON.stringify(student));
                    // 跳转回课堂表现记录器
                    window.location.href = 'classroom-tracker.html';
                } catch (e) {
                    console.error('保存学生数据失败:', e);
                    showCustomModal('错误', '选择学生失败，请重试');
                }
            }
        }
        
        // 渲染学生列表
        function renderStudentList() {
            const students = StudentManager.getStudents();
            studentList.innerHTML = '';
            
            // 检查是否是从其他工具跳转过来的
            const urlParams = new URLSearchParams(window.location.search);
            const fromTracker = urlParams.get('from') === 'tracker';
            const fromRollCall = urlParams.get('from') === 'rollcall';
            const fromGrouping = urlParams.get('from') === 'grouping';
            const fromOtherTool = fromTracker || fromRollCall || fromGrouping;
            
            if (students.length === 0) {
                studentList.innerHTML = '<div class="empty-list">暂无学生，请添加学生</div>';
                return;
            }
            
            students.forEach((student, index) => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                
                // 转义学生信息以防止XSS攻击
                const escapedId = student.id ? escapeHtml(student.id) : '';
                const escapedName = escapeHtml(student.name);
                
                // 如果是从其他工具跳转过来的，添加相应的按钮
                if (fromOtherTool) {
                    const studentInfo = student.id ? 
                        `<span class="student-info"><span class="student-id">${escapedId}</span> - ${escapedName}</span>` : 
                        `<span class="student-info">${escapedName}</span>`;
                    
                    // 根据来源工具显示不同的按钮
                    if (fromTracker) {
                        studentItem.innerHTML = `
                            ${studentInfo}
                            <button class="btn" onclick="selectStudentForTracker(${index})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">选择</button>
                            <button class="remove-student" onclick="removeStudent(${index})">删除</button>
                        `;
                    } else {
                        // 对于随机点名器和小组分组器，只需要显示学生信息和删除按钮
                        studentItem.innerHTML = `
                            ${studentInfo}
                            <button class="remove-student" onclick="removeStudent(${index})">删除</button>
                        `;
                    }
                } else {
                    const studentInfo = student.id ? 
                        `<span class="student-info"><span class="student-id">${escapedId}</span> - ${escapedName}</span>` : 
                        `<span class="student-info">${escapedName}</span>`;
                    
                    studentItem.innerHTML = `
                        ${studentInfo}
                        <button class="remove-student" onclick="removeStudent(${index})">删除</button>
                    `;
                }
                
                studentList.appendChild(studentItem);
            });
        }
        
        // 更新统计摘要
        function updateSummary() {
            const students = StudentManager.getStudents();
            totalStudentsEl.textContent = students.length;
            
            // 建议分组数（每组4-6人）
            const suggestedGroups = Math.max(1, Math.floor(students.length / 5));
            totalGroupsEl.textContent = suggestedGroups;
        }
        
        // 显示邮件提示
        function showEmailPrompt() {
            alert('请发送邮件至：crisweiming@hotmail.com\n\n我们非常期待您的宝贵意见！');
            // 滚动到页面顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 导航到其他页面
        function navigateTo(page) {
            // 检查是否是从课堂表现记录器、随机点名器或小组分组器跳转过来的
            const urlParams = new URLSearchParams(window.location.search);
            const fromTracker = urlParams.get('from') === 'tracker';
            const fromRollCall = urlParams.get('from') === 'rollcall';
            const fromGrouping = urlParams.get('from') === 'grouping';
            
            if (fromTracker || fromRollCall || fromGrouping) {
                // 如果是从其他工具跳转过来的，需要特殊处理
                let message = '请在下方学生列表中添加或选择学生';
                if (fromTracker) {
                    message = '请在下方学生列表中选择要记录表现的学生';
                } else if (fromRollCall) {
                    message = '请在下方学生列表中添加学生，然后返回随机点名器';
                } else if (fromGrouping) {
                    message = '请在下方学生列表中添加学生，然后返回小组分组器';
                }
                
                alert(message);
                // 显示学生管理区域
                if (studentManagementContainer.classList.contains('hidden')) {
                    toggleStudentManagement();
                }
                return;
            }
            
            window.location.href = page;
        }
        
        // 初始化
        function init() {
            // 初始化学生管理器
            StudentManager.init();
            
            // 渲染学生列表
            renderStudentList();
            updateSummary();
            
            // 检查是否是从其他工具跳转过来的
            const urlParams = new URLSearchParams(window.location.search);
            const fromTracker = urlParams.get('from') === 'tracker';
            const fromRollCall = urlParams.get('from') === 'rollcall';
            const fromGrouping = urlParams.get('from') === 'grouping';
            const fromOtherTool = fromTracker || fromRollCall || fromGrouping;
            
            if (fromOtherTool) {
                // 如果是从其他工具跳转过来的，显示学生管理区域
                if (studentManagementContainer.classList.contains('hidden')) {
                    toggleStudentManagement();
                }
                
                // 显示提示信息
                let message = '请在下方学生列表中添加或选择学生';
                if (fromTracker) {
                    message = '请在下方学生列表中选择要记录表现的学生';
                } else if (fromRollCall) {
                    message = '请在下方学生列表中添加学生，然后返回随机点名器';
                } else if (fromGrouping) {
                    message = '请在下方学生列表中添加学生，然后返回小组分组器';
                }
                
                showCustomModal('提示', message);
            }
            
            // 绑定事件监听器
            toggleStudentsBtn.addEventListener('click', toggleStudentManagement);
            addStudentBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                addStudent();
            });
            
            studentName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addStudent();
                    e.stopPropagation();
                }
            });
            
            importBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                importStudents();
            });
            
            importFileBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                importFromFile();
            });
            
            clearStudentsBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                clearStudents();
            });
            
            feedbackBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                showEmailPrompt();
            });
            
            // 文件选择变化时显示文件信息
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    fileInfo.textContent = `文件名: ${file.name} | 大小: ${(file.size / 1024).toFixed(1)} KB | 类型: ${file.type || '未知'}`;
                } else {
                    fileInfo.textContent = '';
                }
            });
        }
        
        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>