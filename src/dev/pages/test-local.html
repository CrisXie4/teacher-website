<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="4a56b2a6-010f-412d-b1ae-59417d30a68d"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æµ‹è¯• - æˆ¿é—´ç æ‘„åƒå¤´ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #6c757d; cursor: not-allowed; }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .room-code {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }
        .test-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
            text-align: center;
        }
    </style>
    <link rel="manifest" href="../../../manifest.json">
    <link rel="icon" href="../../../assets/images/briefcase-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="../../../assets/images/briefcase-192x192.png">
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æœ¬åœ°æµ‹è¯• - æˆ¿é—´ç æ‘„åƒå¤´ç³»ç»Ÿ</h1>

        <div id="serverStatus" class="status disconnected">
            æœåŠ¡å™¨çŠ¶æ€ï¼šæœªè¿æ¥
        </div>

        <div class="test-section">
            <h3>ğŸ“¡ æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h3>
            <button id="testConnection" class="button">æµ‹è¯•è¿æ¥</button>
            <button id="testApi" class="button">æµ‹è¯• API</button>
            <div id="connectionResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¥ æ•™å¸ˆç«¯æµ‹è¯•</h3>
            <button id="createRoom" class="button" disabled>åˆ›å»ºæˆ¿é—´</button>
            <div id="roomCode" class="room-code" style="display: none;"></div>
            <div id="teacherResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ è§‚çœ‹è€…æµ‹è¯•</h3>
            <input type="text" id="joinRoomCode" class="test-input" placeholder="è¾“å…¥æˆ¿é—´ç " maxlength="6">
            <button id="joinRoom" class="button" disabled>åŠ å…¥æˆ¿é—´</button>
            <div id="viewerResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults"></div>
        </div>
    </div>
    <footer>
        <p>&copy; 2025 æ•™å¸ˆå·¥å…·ç®± - æœ¬åœ°æµ‹è¯•</p>
        <div class="signature-badge">â­ï¸ Made By CrisXie & Zhang Monday â­ï¸</div>
    </footer>

    <script>
        let socket = null;
        let clientId = null;
        let currentRoomCode = null;

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
        function updateServerStatus(message, isConnected = false) {
            const status = document.getElementById('serverStatus');
            status.textContent = 'æœåŠ¡å™¨çŠ¶æ€ï¼š' + message;
            status.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, success = true) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.color = success ? 'green' : 'red';
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // æµ‹è¯•è¿æ¥
        function testConnection() {
            updateServerStatus('æ­£åœ¨è¿æ¥...', false);
            addTestResult('å¼€å§‹æµ‹è¯• WebSocket è¿æ¥...');

            const wsUrl = `ws://${window.location.hostname}:3000`;
            console.log('æµ‹è¯•è¿æ¥åˆ°:', wsUrl);

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                updateServerStatus('å·²è¿æ¥', true);
                addTestResult('âœ… WebSocket è¿æ¥æˆåŠŸ');
                document.getElementById('createRoom').disabled = false;
                document.getElementById('joinRoom').disabled = false;
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                handleMessage(data);
            };

            socket.onclose = () => {
                updateServerStatus('è¿æ¥æ–­å¼€', false);
                addTestResult('âŒ WebSocket è¿æ¥æ–­å¼€');
                document.getElementById('createRoom').disabled = true;
                document.getElementById('joinRoom').disabled = true;
            };

            socket.onerror = (error) => {
                updateServerStatus('è¿æ¥å¤±è´¥', false);
                addTestResult('âŒ WebSocket è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨ localhost:3000');
                console.error('è¿æ¥é”™è¯¯:', error);
            };
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(data) {
            switch (data.type) {
                case 'connection':
                    clientId = data.id;
                    addTestResult(`âœ… è·å¾—å®¢æˆ·ç«¯ ID: ${clientId}`);
                    break;

                case 'room-created':
                    currentRoomCode = data.roomCode;
                    document.getElementById('roomCode').textContent = `æˆ¿é—´ç : ${currentRoomCode}`;
                    document.getElementById('roomCode').style.display = 'block';
                    addTestResult(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œæˆ¿é—´ç : ${currentRoomCode}`);
                    break;

                case 'room-joined':
                    addTestResult(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´: ${data.roomCode}`);
                    break;

                case 'viewer-joined':
                    addTestResult(`âœ… æœ‰è§‚çœ‹è€…åŠ å…¥äº†æˆ¿é—´`);
                    break;

                case 'error':
                    addTestResult(`âŒ é”™è¯¯: ${data.message}`, false);
                    break;
            }
        }

        // æµ‹è¯• API
        async function testApi() {
            addTestResult('å¼€å§‹æµ‹è¯• API ç«¯ç‚¹...');

            try {
                const response = await fetch(`http://${window.location.hostname}:3000/api/status`);
                const data = await response.json();

                if (data.status === 'running') {
                    addTestResult('âœ… API ç«¯ç‚¹æ­£å¸¸å·¥ä½œ');
                    addTestResult(`   - è¿æ¥çš„å®¢æˆ·ç«¯: ${data.connectedClients}`);
                    addTestResult(`   - æ´»è·ƒæˆ¿é—´: ${data.activeRooms}`);
                    addTestResult(`   - Supabase é…ç½®: ${data.environment.supabaseConfigured ? 'å·²é…ç½®' : 'æœªé…ç½®'}`);
                } else {
                    addTestResult('âŒ API è¿”å›å¼‚å¸¸çŠ¶æ€', false);
                }
            } catch (error) {
                addTestResult('âŒ API è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨ localhost:3000', false);
            }
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addTestResult('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', false);
                return;
            }

            addTestResult('åˆ›å»ºæˆ¿é—´...');
            socket.send(JSON.stringify({ type: 'create-room' }));
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value.trim();

            if (!roomCode) {
                addTestResult('âŒ è¯·è¾“å…¥æˆ¿é—´ç ', false);
                return;
            }

            if (!/^\d{6}$/.test(roomCode)) {
                addTestResult('âŒ æˆ¿é—´ç å¿…é¡»æ˜¯6ä½æ•°å­—', false);
                return;
            }

            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addTestResult('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', false);
                return;
            }

            addTestResult(`å°è¯•åŠ å…¥æˆ¿é—´: ${roomCode}`);
            socket.send(JSON.stringify({ type: 'join-room', roomCode: roomCode }));
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('testConnection').addEventListener('click', testConnection);
        document.getElementById('testApi').addEventListener('click', testApi);
        document.getElementById('createRoom').addEventListener('click', createRoom);
        document.getElementById('joinRoom').addEventListener('click', joinRoom);

        // é™åˆ¶æˆ¿é—´ç è¾“å…¥ä¸ºæ•°å­—
        document.getElementById('joinRoomCode').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            addTestResult('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            addTestResult('è¯·å…ˆç‚¹å‡»"æµ‹è¯•è¿æ¥"æŒ‰é’®');
        });
    </script>
</body>
</html>
