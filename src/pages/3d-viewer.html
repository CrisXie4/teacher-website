<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="4a56b2a6-010f-412d-b1ae-59417d30a68d"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4b6cb7">
    <meta name="description" content="3D观察物体 - 教师工具箱">
    <meta name="keywords" content="3D,观察物体,教学工具,教师工具">
    <meta name="author" content="Teacher Toolkit Team">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="教师工具箱">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="../../manifest.json">
    <link rel="icon" href="../../briefcase-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="../../briefcase-192x192.png">
    <title>3D观察物体 - 教师工具箱</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-btn {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(75, 108, 183, 0.4);
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 108, 183, 0.6);
        }
        
        .container {
            max-width: 1400px;
            margin: 6rem auto 2rem;
            padding: 0 1.5rem;
        }
        
        .page-title {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .page-title h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .page-title p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .viewer-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .controls-section {
            flex: 0 0 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .section-title {
            color: #182848;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }
        
        #viewer-container {
            width: 100%;
            height: 400px;
            background: #f0f0f0;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group h3 {
            color: #182848;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(75, 108, 183, 0.4);
            display: block;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 108, 183, 0.6);
        }
        
        .btn.add {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }
        
        .btn.delete {
            background: linear-gradient(135deg, #FF5722, #FF9800);
        }
        
        .btn.reset {
            background: linear-gradient(135deg, #9C27B0, #E040FB);
        }
        
        .objects-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            background: rgba(248, 249, 250, 0.9);
            margin-top: 1rem;
        }
        
        .object-item {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .object-item:last-child {
            border-bottom: none;
        }
        
        .object-info {
            flex: 1;
        }
        
        .object-name {
            font-weight: bold;
            color: #4b6cb7;
        }
        
        .remove-object {
            background: #ff416c;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .remove-object:hover {
            background: #ff1a4f;
            transform: scale(1.1);
        }
        
        .instructions {
            background: rgba(227, 242, 253, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(179, 219, 255, 0.5);
        }
        
        .instructions h3 {
            color: #182848;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .instructions ul {
            padding-left: 1.5rem;
        }
        
        .instructions li {
            margin-bottom: 0.8rem;
            line-height: 1.6;
            color: #555;
        }
        
        footer {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls-section {
                flex: 1;
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goHome()">← 返回主页</button>
        <h2 style="color: white; margin: 0;">3D观察物体</h2>
        <div style="width: 100px;"></div> <!-- 占位元素保持居中 -->
    </div>
    
    <div class="container">
        <div class="page-title">
            <h1>3D物体观察器</h1>
            <p>创建、编辑和观察3D物体</p>
        </div>
        
        <div class="main-content">
            <div class="viewer-section">
                <h2 class="section-title">3D视图</h2>
                <div id="viewer-container">
                    <!-- 3D视图将在这里渲染 -->
                    <canvas id="webgl-canvas" style="width: 100%; height: 100%;"></canvas>
                </div>
                <p style="text-align: center; color: #666; font-size: 0.9rem;">
                    使用鼠标拖拽旋转视角，滚动鼠标滚轮缩放
                </p>
            </div>
            
            <div class="controls-section">
                <h2 class="section-title">控制面板</h2>
                
                <div class="control-group">
                    <h3>添加新物体</h3>
                    <div class="form-group">
                        <label for="objectType">物体类型</label>
                        <select id="objectType">
                            <option value="cube">立方体</option>
                            <option value="sphere">球体</option>
                            <option value="cylinder">圆柱体</option>
                            <option value="cone">圆锥体</option>
                            <option value="pyramid">金字塔</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="objectName">物体名称</label>
                        <input type="text" id="objectName" placeholder="例如：我的立方体">
                    </div>
                    
                    <div class="form-group">
                        <label for="objectColor">物体颜色</label>
                        <input type="color" id="objectColor" value="#4b6cb7">
                    </div>
                    
                    <button class="btn add" onclick="addObject()">添加物体</button>
                </div>
                
                <div class="control-group">
                    <h3>现有物体</h3>
                    <div id="objectsList" class="objects-list">
                        <div class="empty-list">暂无物体，请添加物体</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <button class="btn reset" onclick="resetViewer()">重置视图</button>
                    <button class="btn delete" onclick="clearAllObjects()">清空所有物体</button>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>使用说明</h3>
            <ul>
                <li><strong>添加物体</strong> - 选择物体类型、输入名称和颜色，点击"添加物体"</li>
                <li><strong>观察物体</strong> - 在3D视图区域使用鼠标拖拽旋转视角，滚动鼠标滚轮缩放</li>
                <li><strong>移动物体</strong> - 点击并拖动物体可以移动它们的位置</li>
                <li><strong>删除物体</strong> - 在控制面板的"现有物体"列表中点击物体旁的删除按钮</li>
                <li><strong>重置视图</strong> - 点击"重置视图"按钮恢复默认视角</li>
                <li><strong>清空物体</strong> - 点击"清空所有物体"按钮删除所有添加的物体</li>
            </ul>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 教师工具箱 - 专为教师设计</p>
    </footer>
    
    <!-- 引入Three.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // 物体数据存储
        let objects = [];
        let objectIdCounter = 1;
        
        // Three.js相关变量
        let scene, camera, renderer;
        let objectMeshes = [];
        
        // 返回主页
        function goHome() {
            window.location.href = '../../index.html';
        }
        
        // 初始化Three.js
        function initThreeJS() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(75, 
                document.getElementById('viewer-container').clientWidth / 
                document.getElementById('viewer-container').clientHeight, 
                0.1, 1000);
            camera.position.z = 5;
            
            // 创建渲染器
            const canvas = document.getElementById('webgl-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(
                document.getElementById('viewer-container').clientWidth,
                document.getElementById('viewer-container').clientHeight
            );
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // 添加鼠标控制
            let isDragging = false;
            let previousMousePosition = {
                x: 0,
                y: 0
            };
            let selectedObject = null;
            let dragPlane = new THREE.Plane();
            let dragOffset = new THREE.Vector3();
            let raycaster = new THREE.Raycaster();
            let mouse = new THREE.Vector2();
            
            // 鼠标按下事件
            canvas.addEventListener('mousedown', function(e) {
                // 计算鼠标位置
                mouse.x = (e.offsetX / canvas.clientWidth) * 2 - 1;
                mouse.y = -(e.offsetY / canvas.clientHeight) * 2 + 1;
                
                // 设置射线
                raycaster.setFromCamera(mouse, camera);
                
                // 获取所有物体
                const allMeshes = objectMeshes.map(item => item.mesh);
                
                // 检测交点
                const intersects = raycaster.intersectObjects(allMeshes);
                
                if (intersects.length > 0) {
                    // 选择了物体
                    selectedObject = intersects[0].object;
                    isDragging = true;
                    
                    // 计算拖拽偏移
                    dragOffset.copy(intersects[0].point).sub(selectedObject.position);
                    
                    // 设置拖拽平面
                    dragPlane.setFromNormalAndCoplanarPoint(
                        camera.getWorldDirection(new THREE.Vector3()),
                        selectedObject.position
                    );
                } else {
                    // 没有选择物体，旋转场景
                    isDragging = true;
                }
            });
            
            // 鼠标移动事件
            canvas.addEventListener('mousemove', function(e) {
                if (isDragging && selectedObject) {
                    // 移动物体
                    mouse.x = (e.offsetX / canvas.clientWidth) * 2 - 1;
                    mouse.y = -(e.offsetY / canvas.clientHeight) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);

                    let intersection = new THREE.Vector3();
                    if (raycaster.ray.intersectPlane(dragPlane, intersection)) {
                        selectedObject.position.copy(intersection.sub(dragOffset));
                    }
                    requestRender(); // 触发重新渲染
                } else if (isDragging) {
                    // 旋转场景
                    const deltaMove = {
                        x: e.offsetX - previousMousePosition.x,
                        y: e.offsetY - previousMousePosition.y
                    };

                    const deltaRotationQuaternion = new THREE.Quaternion()
                        .setFromEuler(new THREE.Euler(
                            toRadians(deltaMove.y * 1),
                            toRadians(deltaMove.x * 1),
                            0,
                            'XYZ'
                        ));

                    scene.quaternion.multiplyQuaternions(deltaRotationQuaternion, scene.quaternion);
                    requestRender(); // 触发重新渲染
                }

                previousMousePosition = {
                    x: e.offsetX,
                    y: e.offsetY
                };
            });
            
            // 鼠标释放事件
            canvas.addEventListener('mouseup', function(e) {
                isDragging = false;
                selectedObject = null;
            });
            
            // 鼠标离开事件
            canvas.addEventListener('mouseleave', function(e) {
                isDragging = false;
                selectedObject = null;
            });
            
            // 鼠标滚轮事件
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.min(Math.max(camera.position.z, 2), 10);
                requestRender(); // 触发重新渲染
            });
            
            // 窗口大小改变事件
            window.addEventListener('resize', function() {
                camera.aspect = document.getElementById('viewer-container').clientWidth /
                                document.getElementById('viewer-container').clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(
                    document.getElementById('viewer-container').clientWidth,
                    document.getElementById('viewer-container').clientHeight
                );
                requestRender(); // 触发重新渲染
            });
            
            // 开始渲染循环
            let needsRender = true; // 按需渲染标志

            function animate() {
                requestAnimationFrame(animate);
                if (needsRender) {
                    renderer.render(scene, camera);
                    needsRender = false; // 渲染后重置标志
                }
            }

            // 标记需要重新渲染的辅助函数
            function requestRender() {
                needsRender = true;
            }
            
            animate();
        }
        
        // 角度转弧度
        function toRadians(angle) {
            return angle * (Math.PI / 180);
        }
        
        // 添加物体
        function addObject() {
            const type = document.getElementById('objectType').value;
            const name = document.getElementById('objectName').value.trim();
            const color = document.getElementById('objectColor').value;
            
            if (!name) {
                alert('请输入物体名称');
                return;
            }
            
            const object = {
                id: objectIdCounter++,
                type: type,
                name: name,
                color: color
            };
            
            objects.push(object);
            renderObjectsList();
            create3DObject(object);
        }
        
        // 创建3D物体
        function create3DObject(object) {
            let geometry, material, mesh;
            
            // 根据类型创建几何体
            switch (object.type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                    break;
                case 'pyramid':
                    geometry = new THREE.ConeGeometry(0.5, 1, 4);
                    break;
            }
            
            // 创建材质
            material = new THREE.MeshPhongMaterial({ 
                color: object.color,
                shininess: 30
            });
            
            // 创建网格
            mesh = new THREE.Mesh(geometry, material);
            
            // 设置位置（避免重叠）
            const spacing = 2;
            const gridSize = Math.ceil(Math.sqrt(objects.length));
            const index = objects.findIndex(obj => obj.id === object.id);
            const row = Math.floor(index / gridSize);
            const col = index % gridSize;
            
            mesh.position.x = (col - (gridSize - 1) / 2) * spacing;
            mesh.position.y = (row - (gridSize - 1) / 2) * spacing;
            
            // 为物体添加交互功能
            mesh.userData = { objectId: object.id };
            
            // 添加到场景和数组
            scene.add(mesh);
            objectMeshes.push({ id: object.id, mesh: mesh });
            requestRender(); // 触发重新渲染
        }
        
        // 删除物体
        function removeObject(id) {
            if (confirm('确定要删除这个物体吗？')) {
                // 从数组中移除
                objects = objects.filter(obj => obj.id !== id);
                
                // 从场景中移除对应的网格
                const meshIndex = objectMeshes.findIndex(item => item.id === id);
                if (meshIndex !== -1) {
                    scene.remove(objectMeshes[meshIndex].mesh);
                    objectMeshes.splice(meshIndex, 1);
                }

                renderObjectsList();
                requestRender(); // 触发重新渲染
            }
        }
        
        // 渲染物体列表
        function renderObjectsList() {
            const container = document.getElementById('objectsList');
            
            if (objects.length === 0) {
                container.innerHTML = '<div class="empty-list">暂无物体，请添加物体</div>';
                return;
            }
            
            container.innerHTML = '';
            objects.forEach(obj => {
                const item = document.createElement('div');
                item.className = 'object-item';
                item.innerHTML = `
                    <div class="object-info">
                        <span class="object-name">${obj.name}</span>
                        <br>
                        <small>${getObjectTypeName(obj.type)}</small>
                    </div>
                    <button class="remove-object" onclick="removeObject(${obj.id})">删除</button>
                `;
                container.appendChild(item);
            });
        }
        
        // 获取物体类型名称
        function getObjectTypeName(type) {
            const types = {
                'cube': '立方体',
                'sphere': '球体',
                'cylinder': '圆柱体',
                'cone': '圆锥体',
                'pyramid': '金字塔'
            };
            return types[type] || type;
        }
        
        // 重置视图
        function resetViewer() {
            // 重置相机位置
            camera.position.set(0, 0, 5);
            camera.lookAt(0, 0, 0);
            
            // 重置场景旋转
            scene.rotation.set(0, 0, 0);
        }
        
        // 清空所有物体
        function clearAllObjects() {
            if (objects.length === 0) {
                alert('当前没有物体可以删除');
                return;
            }
            
            if (confirm('确定要清空所有物体吗？')) {
                // 从场景中移除所有网格
                objectMeshes.forEach(item => {
                    scene.remove(item.mesh);
                });
                
                // 清空数组
                objects = [];
                objectMeshes = [];
                
                renderObjectsList();
            }
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initThreeJS();
            renderObjectsList();
        };
    </script>
</body>
</html>
